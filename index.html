<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>地点マップ</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
  :root{ --bg:#fafafa; --ink:#111; --muted:#6b6b6b; --line:#dcdcdc; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
  .h{font-weight:800;font-size:18px;margin:0 0 8px}

  .row{display:grid;grid-template-columns:1fr 180px;gap:10px}
  .ctl{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  select,button{height:44px;border:1px solid var(--line);border-radius:10px;font-size:14px;padding:0 10px;background:#fff;cursor:pointer;font-weight:700}

  #map{height:60vh;border-radius:12px;border:1px solid var(--line);margin-top:12px}
  .divider{height:1px;background:var(--line);margin:12px 0}

  .group-ui{display:grid;gap:8px;margin-top:10px}
  details.group{border:1px solid var(--line);border-radius:10px;background:#fff}
  details.group > summary{list-style:none;cursor:pointer;padding:10px 12px;display:flex;align-items:center;gap:10px;font-weight:700;}
  details.group[open] > summary{border-bottom:1px solid var(--line);}
  .dot{width:14px;height:14px;border-radius:50%}
  .count{margin-left:auto;color:var(--muted);font-weight:600}
  .plist{margin:0;padding:8px 10px 10px;list-style:none;display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
  .item{display:flex;align-items:center;gap:10px;cursor:pointer;padding:6px 8px;border-radius:8px}
  .item:hover{background:#f2f2f2}

  .badge{min-width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
  .nm{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:560px}

  .pin-base{width:28px;height:28px;color:#fff;font-weight:800;font-size:14px;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.95);box-shadow:0 2px 6px rgba(0,0,0,.35);line-height:1;}
  .pin-circle{border-radius:50%;}
  .pin-square{border-radius:6px;}
  .pin-diamond{width:26px;height:26px;transform:rotate(45deg);border-radius:6px;}
  .pin-diamond>span{transform:rotate(-45deg);display:inline-block;}

  .gmaps-link{color:#1976d2;text-decoration:none;}
  .gmaps-link:hover{text-decoration:underline;}

  @media(max-width:600px){ .row{grid-template-columns:1fr 1fr;} }
</style>
</head>

<body>
<div class="wrap">
  <div class="card" style="padding:14px;">
    <p class="h">地点マップ</p>

    <div class="row">
      <div class="ctl">
        <label>リスト選択</label>
        <select id="dataset"></select>
      </div>
      <div class="ctl">
        <label>&nbsp;</label>
        <button id="reload">表示</button>
      </div>
    </div>

    <div class="divider"></div>

    <div id="groupList" class="group-ui"></div>

    <div class="divider"></div>

    <div id="map"></div>

    <div class="divider"></div>

    <div style="display:flex;justify-content:flex-end;">
      <button id="openRaw">元データを開く</button>
    </div>

  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
const MANIFEST_URL = "data/manifest.json";

const map = L.map('map').setView([27.0, 128.4], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let layerGroup = L.layerGroup().addTo(map);

const $=s=>document.querySelector(s);
const dsSel=$("#dataset"), btnReload=$("#reload"), btnOpen=$("#openRaw"), groupList=$("#groupList");

let rows=[], markers=[], grpColors={};

function normalizeHeader(s){
  return String(s).replace(/[\u3000\s]+/g,"").toLowerCase();
}

function readHeaders(){
  const headers = Object.keys(rows[0]);
  return {
    name: headers.find(h=>normalizeHeader(h).includes("名")),
    lat:  headers.find(h=>normalizeHeader(h).includes("緯")),
    lng:  headers.find(h=>normalizeHeader(h).includes("経")),
    desc: headers.find(h=>normalizeHeader(h).includes("説")),
    grp:  headers.find(h=>normalizeHeader(h).includes("備")||normalizeHeader(h).includes("グル")),
    num:  headers.find(h=>normalizeHeader(h).includes("番")),
    shp:  headers.find(h=>normalizeHeader(h).includes("形")),
    url:  headers.find(h=>normalizeHeader(h).includes("url"))
  };
}

function parseNum(v){
  const n=Number(String(v).replace(/[^\d\.\-]/g,""));
  return Number.isFinite(n)?n:NaN;
}

function color(grp,i){
  const P=["#e6194b","#3cb44b","#0082c8","#f58231","#911eb4","#46f0f0","#f032e6","#d2f53c","#fabebe","#008080","#e6beff","#aa6e28"];
  if(grpColors[grp])return grpColors[grp];
  grpColors[grp]=P[i%P.length]; return grpColors[grp];
}

function normShape(v){
  v=(v??"").toString();
  if(v.includes("四")||v.includes("□")) return "square";
  if(v.includes("ひ")||v.includes("菱")) return "diamond";
  return "circle";
}

function icon(label,c,s){
  const html =
    s==="diamond" ? `<div class="pin-base pin-diamond" style="background:${c}"><span>${label}</span></div>` :
    s==="square"  ? `<div class="pin-base pin-square" style="background:${c}">${label}</div>` :
                    `<div class="pin-base pin-circle" style="background:${c}">${label}</div>`;
  return L.divIcon({html,className:"",iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-14]});
}

function mapsHref(r, urlK, lat, lng){
  return `https://www.google.com/maps/search/?api=1&query=${lat},${lng}&source=web`;
}

function render(){
  const H = readHeaders();
  if(!H.name||!H.lat||!H.lng){ alert("必須列不足"); return; }

  markers=[]; grpColors={}; layerGroup.clearLayers();
  const by={}, groups=[];
  let id=1, seq=1;
  const mks=[];

  rows.forEach(r=>{
    const name=(r[H.name]??"").toString().trim();
    const lat=parseNum(r[H.lat]), lng=parseNum(r[H.lng]);
    if(!name || !Number.isFinite(lat) || !Number.isFinite(lng)) return;

    const grp=(r[H.grp]??"").toString().trim();
    const label=(r[H.num]??"")?r[H.num]:String(seq++);
    const shp = H.shp ? normShape(r[H.shp]) : "circle";
    const ci = groups.includes(grp)?groups.indexOf(grp):(groups.push(grp)-1+1);
    const c = color(grp,ci);
    const href = mapsHref(r,H.url,lat,lng);
    const desc = H.desc?(r[H.desc]??""):"";

    const pop = `<b>${name}</b>${desc?`<br>${desc}`:""}<br>
                 <small><a class="gmaps-link" href="${href}" target="_blank" rel="noopener">Googleマップで開く</a></small><br>
                 <small>グループ: ${grp||"(空白)"}</small>`;

    const mk=L.marker([lat,lng],{icon:icon(label,c,shp)}).bindPopup(pop).addTo(layerGroup);
    markers.push({id, marker:mk, grp});
    if(!by[grp]) by[grp]=[];
    by[grp].push({_id:id,_label:label,_name:name});
    mks.push(mk);
    id++;
  });

  if(mks.length){
    map.fitBounds(L.featureGroup(mks).getBounds().pad(0.2));
    groupList.innerHTML="";
    Object.keys(by).forEach((g,i)=>{
      const det=document.createElement("details");
      det.className="group";
      const sum=document.createElement("summary");
      sum.innerHTML=`<span class="dot" style="background:${color(g,i)}"></span>${g||"(空白)"}<span class="count">${by[g].length} 件</span>`;
      const ul=document.createElement("ul"); ul.className="plist";
      by[g].forEach(rec=>{
        const li=document.createElement("li");
        li.className="item";
        li.innerHTML=`<span class="badge" style="background:${color(g,i)}">${rec._label}</span><span class="nm">${rec._name}</span>`;
        li.onclick=()=>{
          const mm=markers.find(m=>m.id===rec._id);
          if(!mm)return;
          document.getElementById("map").scrollIntoView({behavior:"smooth"});
          map.setView(mm.marker.getLatLng(),15);
          mm.marker.openPopup();
        };
        ul.append(li);
      });
      det.append(sum,ul);
      groupList.append(det);
    });
  }
}

async function loadRows(url){
  const buf = await (await fetch(url,{cache:"no-store"})).arrayBuffer();
  rows = XLSX.utils.sheet_to_json(XLSX.read(buf,{type:"array"}).Sheets["Sheet1"],{defval:""});
}

async function init(){
  const mf = await (await fetch(MANIFEST_URL,{cache:"no-store"})).json();
  dsSel.innerHTML = mf.map((d,i)=>`<option value="${i}">${d.name}</option>`).join("");
  dsSel.onchange=()=>load(mf);
  btnReload.onclick=()=>load(mf);
  load(mf);
}

async function load(mf){
  const item = mf[Number(dsSel.value)||0];
  btnOpen.onclick=()=>window.open(item.url,"_blank");
  await loadRows(item.url);
  render();
}

init();
</script>

<script>
if ("serviceWorker" in navigator) navigator.serviceWorker.register("service-worker.js");
</script>

</body>
</html>
