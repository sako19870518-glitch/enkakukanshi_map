<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>地点マップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root{ --bg:#fafafa; --ink:#111; --muted:#6b6b6b; --line:#dcdcdc; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
  .h{font-weight:800;font-size:18px;margin:0 0 8px}
  .row{display:grid;grid-template-columns: 1fr 200px 180px; gap:10px}
  .ctl{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  select,input[type=file],button{height:44px;border:1px solid var(--line);border-radius:10px;font-size:14px;padding:0 10px;background:#fff}
  button{cursor:pointer;font-weight:700}
  #map{height:66vh;border-radius:12px;border:1px solid var(--line);margin-top:12px}

  .toolbar{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; align-items:center}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff}
  .dot{width:14px; height:14px; border-radius:50%}
  .divider{height:1px; background:var(--line); margin:10px 0}
  .footer{color:var(--muted);font-size:12px;margin-top:8px}

  /* ピン（丸 / 四角 / ひし形） */
  .pin-base{
    width:28px; height:28px; color:#fff; font-weight:800; font-size:14px;
    display:flex; align-items:center; justify-content:center;
    border:2px solid rgba(255,255,255,.95);
    box-shadow:0 2px 6px rgba(0,0,0,.3); line-height:1;
  }
  .pin-circle{ border-radius:50%; }
  .pin-square{ border-radius:6px; }
  .pin-diamond{ width:26px; height:26px; transform: rotate(45deg); border-radius:6px; }
  .pin-diamond > span{ transform: rotate(-45deg); display:inline-block; }

  @media (max-width:820px){ .row{grid-template-columns:1fr 180px 140px} }
  @media (max-width:560px){ .row{grid-template-columns:1fr; } }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="padding:14px 14px 10px">
      <p class="h">地点マップ</p>
      <div class="row">
        <div class="ctl">
          <label>ファイル（.xlsx / .xls / .csv）</label>
          <input id="file" type="file" accept=".xlsx,.xls,.csv" />
        </div>
        <div class="ctl">
          <label>表示の切替</label>
          <select id="displayMode">
            <option value="name">名称</option>
            <option value="number">番号</option>
          </select>
        </div>
        <div class="ctl">
          <label>&nbsp;</label>
          <button id="plot">地図に表示</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- グループ（備考）フィルタ -->
      <div id="filters" class="toolbar" style="display:none">
        <button id="allOn"  type="button">全選択</button>
        <button id="allOff" type="button">全解除</button>
        <span class="footer">（チップをクリックで表示切替）</span>
      </div>
    </div>

    <div id="map"></div>
    <div class="footer">※ 列の指定は自動判定。足りない場合はエラーで知らせます。</div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // Leaflet
    const map = L.map('map', { zoomControl: true }).setView([35,135], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    let layerGroup = L.layerGroup().addTo(map);

    const $ = s => document.querySelector(s);
    const filtersEl = $("#filters");
    const displaySel = $("#displayMode");

    let rows = [];
    let markers = [];
    let grpState = {};
    let grpColors = {};

    // 自動認識キー
    const NAME_KEYS = ["名称","名前","地点名","ラベル","名","name","title"];
    const LAT_KEYS  = ["緯度","latitude","lat","Lat","LAT"];
    const LNG_KEYS  = ["経度","longitude","long","lng","Lon","LNG","lon"];
    const DESC_KEYS = ["説明","備考説明","注記","note","desc","description"];
    const GRP_KEYS  = ["備考","グループ","カテゴリ","区分","分類","班","ブロック","group","category","class"];
    const NUM_KEYS  = ["番号","No","no","num","番号No"];
    const SHP_KEYS  = ["形","形状","マーカー形","shape","marker","記号"];

    // 読み込み
    $("#file").addEventListener("change", async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type:"array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval:"", raw:true });
      if(json.length === 0){ alert("データが空です。1行目=ヘッダー、2行目以降=データにしてください。"); return; }
      rows = json;
    });

    // 色
    const PALETTE = [
      "#e6194b","#3cb44b","#0082c8","#f58231","#911eb4",
      "#46f0f0","#f032e6","#d2f53c","#fabebe","#008080",
      "#e6beff","#aa6e28","#fffac8","#800000","#aaffc3",
      "#808000","#ffd8b1","#000080","#808080","#ffe119"
    ];
    function colorForGroup(grp, i){
      if(grpColors[grp]) return grpColors[grp];
      const c = i < PALETTE.length ? PALETTE[i] : `hsl(${(i*57)%360} 75% 45%)`;
      grpColors[grp] = c; return c;
    }

    // 正規化
    function normShape(v){
      const s = (v ?? "").toString().trim().toLowerCase();
      if(["四角","しかく","square","□","正方形","長方形"].some(k=>s.includes(k))) return "square";
      if(["ひし","菱","diamond","ダイヤ"].some(k=>s.includes(k))) return "diamond";
      return "circle";
    }
    function parseNum(v){
      const n = Number((v ?? "").toString().replace(/[^\d\.\-]/g,""));
      return Number.isFinite(n) ? n : NaN;
    }
    function shortName(v){
      const s = (v ?? "").toString().trim();
      // 全角も考慮して最大2文字だけ表示
      return [...s].slice(0,2).join("") || "?";
    }

    function numberIcon(label, color, shape){
      const safe = (label ?? "").toString();
      let html = "";
      if(shape === "diamond"){
        html = `<div class="pin-base pin-diamond" style="background:${color};border-color:${color};"><span>${safe}</span></div>`;
      }else if(shape === "square"){
        html = `<div class="pin-base pin-square"  style="background:${color};border-color:${color};">${safe}</div>`;
      }else{
        html = `<div class="pin-base pin-circle"  style="background:${color};border-color:${color};">${safe}</div>`;
      }
      return L.divIcon({ html, className:"", iconSize:[28,28], iconAnchor:[14,14], popupAnchor:[0,-14] });
    }

    // 列自動検出
    function autoKey(headers, keys){
      const lower = headers.map(h=>h.toString().toLowerCase());
      for(const k of keys){
        const i = lower.indexOf(k.toLowerCase());
        if(i>=0) return headers[i];
      }
      return null;
    }

    // フィルタUI
    function buildFilterUI(groups){
      filtersEl.style.display = groups.length ? "" : "none";
      filtersEl.querySelectorAll(".chip.grp").forEach(el=>el.remove());
      groups.forEach((g,i)=>{
        const chip = document.createElement("button");
        chip.type="button"; chip.className="chip grp"; chip.dataset.grp=g;
        const dot = document.createElement("span"); dot.className="dot"; dot.style.background=colorForGroup(g,i);
        const label = document.createElement("span"); label.textContent = g || "(空白)";
        chip.append(dot,label);
        grpState[g]=true; chip.style.opacity="1";
        chip.onclick=()=>{ grpState[g]=!grpState[g]; chip.style.opacity = grpState[g]?"1":".35"; applyFilter(); };
        filtersEl.appendChild(chip);
      });
      $("#allOn").onclick = ()=>{ Object.keys(grpState).forEach(k=>grpState[k]=true);  filtersEl.querySelectorAll(".chip.grp").forEach(el=>el.style.opacity="1");  applyFilter(); };
      $("#allOff").onclick= ()=>{ Object.keys(grpState).forEach(k=>grpState[k]=false); filtersEl.querySelectorAll(".chip.grp").forEach(el=>el.style.opacity=".35"); applyFilter(); };
    }

    let layerMarkers = [];
    function applyFilter(){
      layerGroup.clearLayers();
      const vis=[];
      layerMarkers.forEach(({marker, grp})=>{
        if(grpState[grp] ?? true){ marker.addTo(layerGroup); vis.push(marker); }
      });
      if(vis.length){ const group=L.featureGroup(vis); map.fitBounds(group.getBounds().pad(0.2)); }
    }

    // 描画
    $("#plot").addEventListener("click", ()=>{
      if(rows.length===0){ alert("先にファイルを選んでください。"); return; }

      const headers = Object.keys(rows[0]);
      const nameKey = autoKey(headers, NAME_KEYS);
      const latKey  = autoKey(headers, LAT_KEYS);
      const lngKey  = autoKey(headers, LNG_KEYS);

      if(!nameKey || !latKey || !lngKey){
        alert([
          "必要な列が不足しています。",
          `名称=${nameKey||"×"} / 緯度=${latKey||"×"} / 経度=${lngKey||"×"}`,
          "列名の例：名称, 緯度, 経度"
        ].join("\n"));
        return;
      }

      const descKey = autoKey(headers, DESC_KEYS);      // 任意
      const grpKey  = autoKey(headers, GRP_KEYS);       // 備考など（任意）
      const numKey  = autoKey(headers, NUM_KEYS);       // 任意
      const shpKey  = autoKey(headers, SHP_KEYS);       // 任意

      // グループ一覧
      let groups = [];
      if(grpKey){ groups = [...new Set(rows.map(r => (r[grpKey] ?? "").toString().trim()))]; }

      layerGroup.clearLayers();
      layerMarkers = []; grpState = {}; grpColors = {};

      const mode = displaySel.value; // name / number
      let autoNum = 1;
      const ms = [];

      rows.forEach(r=>{
        const name = (r[nameKey] ?? "").toString().trim();
        const lat  = parseNum(r[latKey]);
        const lng  = parseNum(r[lngKey]);
        if(!name || !Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const desc = descKey ? (r[descKey] ?? "").toString() : "";
        const grp  = grpKey ? (r[grpKey] ?? "").toString().trim() : "";
        const shp  = shpKey ? normShape(r[shpKey]) : "circle";

        // アイコンに入れるラベル
        let label;
        if(mode==="name") label = shortName(name);
        else {
          let v = numKey ? (r[numKey] ?? "").toString().trim() : "";
          if(v==="") v = String(autoNum++);
          label = isFinite(Number(v)) ? String(Number(v)) : v;
        }

        const color = grpKey ? colorForGroup(grp, groups.indexOf(grp)) : "#1976d2";
        const icon  = numberIcon(label, color, shp);
        const html  = `<b>${name}</b>${desc?`<br>${desc}`:''}${grpKey?`<br><small style="color:#666">グループ: ${grp||"(空白)"} / 形: ${shp}</small>`:''}`;

        const marker = L.marker([lat,lng], {icon}).bindPopup(html);
        layerMarkers.push({marker, grp});
        ms.push(marker);
      });

      if(ms.length===0){ alert("有効な行がありません（名称・緯度・経度を確認）。"); filtersEl.style.display="none"; return; }

      if(grpKey) buildFilterUI(groups); else filtersEl.style.display="none";

      ms.forEach(m=>m.addTo(layerGroup));
      const group = L.featureGroup(ms); map.fitBounds(group.getBounds().pad(0.2));
    });
  </script>
</body>
</html>
