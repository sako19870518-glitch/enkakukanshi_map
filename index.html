<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>地点マップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root{ --bg:#fafafa; --ink:#111; --muted:#6b6b6b; --line:#dcdcdc; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
  .h{font-weight:800;font-size:18px;margin:0 0 8px}
  .row{display:grid;grid-template-columns: 1fr 180px; gap:10px}
  .ctl{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input[type=file],button{height:44px;border:1px solid var(--line);border-radius:10px;font-size:14px;padding:0 10px;background:#fff}
  button{cursor:pointer;font-weight:700}
  #map{height:58vh;border-radius:12px;border:1px solid var(--line);margin-top:12px}

  .divider{height:1px; background:var(--line); margin:10px 0}

  .group-ui{display:grid; gap:8px; margin-top:10px}
  details.group{border:1px solid var(--line); border-radius:10px; background:#fff}
  details.group > summary{
    list-style:none; cursor:pointer; padding:10px 12px; display:flex; align-items:center; gap:10px;
    font-weight:700;
  }
  details.group[open] > summary{ border-bottom:1px solid var(--line); }
  .dot{width:14px;height:14px;border-radius:50%}
  .count{margin-left:auto; color:var(--muted); font-weight:600}
  .plist{margin:0; padding:8px 10px 10px 10px; list-style:none; display:flex; flex-direction:column; gap:6px; max-height:220px; overflow:auto}
  .item{display:flex; align-items:center; gap:10px; cursor:pointer; padding:6px 8px; border-radius:8px}
  .item:hover{background:#f3f3f3}
  .badge{min-width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff}
  .nm{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 560px; }

  .pin-base{
    width:28px; height:28px; color:#fff; font-weight:800; font-size:14px;
    display:flex; align-items:center; justify-content:center;
    border:2px solid rgba(255,255,255,.95);
    box-shadow:0 2px 6px rgba(0,0,0,.3); line-height:1; }
  .pin-circle{ border-radius:50%; }
  .pin-square{ border-radius:6px; }
  .pin-diamond{ width:26px; height:26px; transform: rotate(45deg); border-radius:6px; }
  .pin-diamond > span{ transform: rotate(-45deg); display:inline-block; }

  .gmaps-link{ color:#1976d2; text-decoration:none; }
  .gmaps-link:hover{ text-decoration:underline; }

  @media (max-width:560px){ .plist{max-height:unset} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="padding:14px 14px 10px">
      <p class="h">地点マップ</p>
      <div class="row">
        <div class="ctl">
          <label>ファイル（.xlsx / .xls / .csv）</label>
          <input id="file" type="file" accept=".xlsx,.xls,.csv" />
        </div>
        <div class="ctl">
          <label>&nbsp;</label>
          <button id="plot">地図に表示</button>
        </div>
      </div>

      <div id="map"></div>

      <div class="divider"></div>
      <div id="groupList" class="group-ui"></div>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
const map = L.map('map').setView([35,135], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let layerGroup = L.layerGroup().addTo(map);

let rows=[], markers=[], grpColors={};

const $=s=>document.querySelector(s);
const groupList=$("#groupList");

const NAME=["名称","名前","地点名","名","name"];
const LAT=["緯度","lat","latitude"];
const LNG=["経度","lng","long","longitude"];
const DESC=["説明","note","desc","備考説明"];
const GRP=["備考","グループ","分類","班","block","group"];
const NUM=["番号","No","num"];
const SHP=["形","shape","記号"];

function findKey(head, list){
  head=head.map(h=>String(h).toLowerCase());
  for(const k of list){
    const i=head.indexOf(k.toLowerCase());
    if(i>=0) return Object.keys(rows[0])[i];
  }
  return null;
}

function normShape(v){
  v=(v||"").toLowerCase();
  if(v.includes("四")||v.includes("□")||v.includes("square")) return "square";
  if(v.includes("ひ")||v.includes("菱")||v.includes("dia")) return "diamond";
  return "circle";
}
function parseNum(v){
  const n=Number(String(v).replace(/[^\d\.\-]/g,""));
  return Number.isFinite(n)?n:NaN;
}

function color(grp,i){
  const P=["#e6194b","#3cb44b","#0082c8","#f58231","#911eb4","#46f0f0","#f032e6","#d2f53c","#fabebe","#008080"];
  if(grpColors[grp])return grpColors[grp];
  grpColors[grp]=P[i%P.length]; return grpColors[grp];
}

function icon(label,c,s){
  let html=s==="diamond"?
  `<div class="pin-base pin-diamond" style="background:${c}"><span>${label}</span></div>`:
  s==="square"?
  `<div class="pin-base pin-square" style="background:${c}">${label}</div>`:
  `<div class="pin-base pin-circle" style="background:${c}">${label}</div>`;
  return L.divIcon({html,className:"",iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-14]});
}

$("#file").addEventListener("change",async e=>{
  const f=e.target.files[0]; if(!f)return;
  const data=await f.arrayBuffer();
  const wb=XLSX.read(data,{type:"array"});
  rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
});

function build(groups, by){
  groupList.innerHTML="";
  groups.forEach((g,i)=>{
    const det=document.createElement("details"); // ← ★ open を付けない = デフォルト閉じる
    det.className="group";

    const sum=document.createElement("summary");
    const dot=document.createElement("span"); dot.className="dot"; dot.style.background=color(g,i);
    const lbl=document.createElement("span"); lbl.textContent=g||"(空白)";
    const cnt=document.createElement("span"); cnt.className="count"; cnt.textContent=by[g].length+" 件";
    sum.append(dot,lbl,cnt);

    const ul=document.createElement("ul"); ul.className="plist";

    by[g].forEach(rec=>{
      const li=document.createElement("li"); li.className="item";
      li.addEventListener("click",()=>{
        const mm=markers.find(m=>m.id===rec._id);
        if(!mm)return;
        document.getElementById("map").scrollIntoView({behavior:"smooth"});
        map.setView(mm.marker.getLatLng(),15);
        mm.marker.openPopup();
      });
      const badge=document.createElement("span");
      badge.className="badge"; badge.style.background=color(g,i); badge.textContent=rec._label;
      const name=document.createElement("span"); name.className="nm"; name.textContent=rec._name;
      li.append(badge,name);
      ul.append(li);
    });

    det.append(sum,ul);
    groupList.append(det);
  });
}

$("#plot").addEventListener("click",()=>{
  if(!rows.length){alert("先にファイルを選んでください");return;}

  const head=Object.keys(rows[0]);
  const nameK=findKey(head,NAME), latK=findKey(head,LAT), lngK=findKey(head,LNG);
  if(!nameK||!latK||!lngK){alert("名称/緯度/経度 列が見つかりません");return;}

  const descK=findKey(head,DESC), grpK=findKey(head,GRP), numK=findKey(head,NUM), shpK=findKey(head,SHP);

  layerGroup.clearLayers(); markers=[]; grpColors={};
  const by={}, groups=[];
  let n=1,id=1,ms=[];

  rows.forEach(r=>{
    const name=r[nameK], lat=parseNum(r[latK]), lng=parseNum(r[lngK]);
    if(!name||!Number.isFinite(lat)||!Number.isFinite(lng))return;

    const grp=grpK?(r[grpK]||"").trim():"";
    let label=numK?(r[numK]||"").toString().trim():"";
    if(label==="")label=String(n++);
    const shp=shpK?normShape(r[shpK]):"circle";
    const c=color(grp,groups.indexOf(grp)>=0?groups.indexOf(grp):groups.push(grp)-1+1);

    const gmaps=`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
    const meta=`<a class="gmaps-link" href="${gmaps}" target="_blank" rel="noopener">グループ: ${grp||"(空白)"}</a>`;
    const html=`<b>${name}</b>${descK?`<br>${r[descK]}`:""}<br><small>${meta}</small>`;

    const m=L.marker([lat,lng],{icon:icon(label,c,shp)}).bindPopup(html);
    m.addTo(layerGroup);
    markers.push({id,marker:m,grp});
    if(!by[grp])by[grp]=[];
    by[grp].push({_id:id,_label:label,_name:name});
    ms.push(m);
    id++;
  });

  if(ms.length){
    const g=L.featureGroup(ms); map.fitBounds(g.getBounds().pad(0.2));
    build(Object.keys(by),by);
  }
});
</script>
</body>
</html>
